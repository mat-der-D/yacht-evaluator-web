# ヨット局面評価Webアプリ 設計書

## 1. 概要

### 1.1 目的

- 単体でヨットを1人でプレイできる
- 任意の局面の評価ができる

### 1.2 基本コンセプト

- プレイモードと局面解析モードを統一レイアウトで提供
- モード切り替えは配色とアイコンで判別
- 評価結果は右サイドパネルで表示(スマホ・PC共通)

---

## 2. 技術スタック

- **フロントエンド**: React 19 + TypeScript + Vite
- **パッケージマネージャー**: Bun
- **状態管理**: React Context API
- **スタイリング**: Plain CSS
- **アニメーション**: CSS Transition

---

## 3. 画面構成

### 3.1 レイアウト(全モード共通)

```
┌─────────────────────────┐
│ [●プレイ] [○局面解析]  │  ← モード切替タブ
├─────────────────────────┤
│ 🎮 / 🔍                 │  ← モードアイコン
│ ┌───┐┌───┐┌───┐┌───┐  │
│ │⚁││⚂││⚂││⚄││⚅│  │  ← ダイス表示
│ └───┘└───┘└───┘└───┘  │
│ [サイコロを振る] あと3回 │  ← 操作ボタン
├─────────────────────────┤
│ [📊 評価を見る]         │  ← 評価ボタン
├─────────────────────────┤
│ ┌──┬────┬────┐       │
│ │役│得点│操作│       │  ← スコアシート
│ └──┴────┴────┘       │
│ 合計: 81                │
└─────────────────────────┘
```

### 3.2 モード構成

#### プレイモード

- 通常のヨットゲームをプレイ
- ダイスを振り、役を確定していく
- 任意のタイミングで評価を確認可能
- 配色: 白背景、青系アクセント
- アイコン: 🎮

#### 局面解析モード

- 任意の局面を手動で設定
- その局面での評価を確認
- プレイモードと同じレイアウト・操作感
- 配色: 薄い黄背景、オレンジ系アクセント
- アイコン: 🔍

---

## 4. ダイスUI

### 4.1 表示形式

サイコロの目をドット表示（⚀⚁⚂⚃⚄⚅）

### 4.2 プレイモード: ダイスロック機能

**通常状態（振り直し対象）**

- 薄いグレーの枠線
- クリックでロック状態に切り替え

**ロック状態（残すダイス）**

- 太い青枠
- 下に南京錠アイコン（🔒）表示
- 再クリックでロック解除

### 4.3 局面解析モード: ダイス編集機能

- オレンジ系の枠線
- クリックで数値を変更（1→2→3→4→5→6→1と循環）
- 南京錠アイコンは表示されない

### 4.4 操作ボタン

#### プレイモード

```
[サイコロを振る] あと3回
```

- 初期状態でも「あと3回」を表示
- `rollsRemaining === 0` のときボタンを無効化
- ゲーム終了時は「リセット」ボタンに変更し、残り回数表示を非表示

#### 局面解析モード

```
○0投目 ○1投目 ●2投目 ○3投目
```

- ラジオボタンで投数を選択
- 0投目（まだ投げていない状態）の選択肢あり
- オレンジ系の色

---

## 5. スコアシート

### 5.1 構成（3カラム）

| 役名カラム (40%) | 得点カラム (30%) | 操作カラム (30%) |
| ---------------- | ---------------- | ---------------- |
| エース           | 3                |                  |
| デュース         | (+8)             | [確定]           |
| トレイ           | 9                |                  |
| フォー           | 0                |                  |
| ファイブ         | -                | [確定]           |
| シックス         | 12               |                  |
| **上段合計**     | **32**           |                  |
| **ボーナス**     | **0**            |                  |
| チョイス         | 22               |                  |
| フォーダイス     | -                | [確定]           |
| フルハウス       | 25               |                  |
| S.ストレート     | -                | [確定]           |
| B.ストレート     | -                | [確定]           |
| ヨット           | -                | [確定]           |
| **合計**         | **81**           |                  |

**役名**: yacht-rules.mdに準拠

- 上段6役: エース、デュース、トレイ、フォー、ファイブ、シックス
- 上段合計（上段6役の合計）
- ボーナス（上段合計63点以上で35点）
- 下段7役: チョイス、フォーダイス、フルハウス、S.ストレート、B.ストレート、ヨット

**上段合計とボーナス行はシックスの直下に配置**（Fragmentを使用して実装）

### 5.2 得点表示

- **数値**: 確定済みの得点
- **`-`**: 未確定（空欄）
- **`(+XX)`**: プレイモードで未確定の場合、現在のダイス目で確定したときの得点をプレビュー
- **0点**: 0点で埋める戦略も可能

### 5.3 操作

#### プレイモード

- 未確定の役に[確定]ボタン表示（`rollCount === 0`のときは非表示）
- ボタンクリックで得点を自動計算してシートに記入
- 確定後は次のターンへ（ダイスリセット、rollsRemaining: 3）

#### 局面解析モード

- 得点欄は入力可能
- [確定]ボタンで自動計算
- 確定後も手動編集可能

### 5.4 視覚的区別

- **確定済み**: 背景色 #f3f4f6（薄いグレー）
- **未確定**: 背景色 白

---

## 6. 評価機能

### 6.1 評価ボタン

スコアシートのすぐ上に配置

```
[📊 評価を見る]
```

- モードに応じて色を変更（青/オレンジ）
- **両モード共通**: `rollCount === 0`のとき非活性（`cursor: not-allowed`）

### 6.2 評価パネル（右サイドパネル）

**動作**

- ボタンクリックで右からスライドイン（0.3秒）
- 背景に半透明の黒オーバーレイ
- パネル外クリック or [×]ボタンで閉じる

**幅**

- スマホ: 85%
- タブレット: 400px
- PC: 450-500px

**構造**

```
┌──────────────────────────┐
│ 評価結果        [× 閉じる]│
├──────────────────────────┤
│ [⚂][⚂]残す              │
│ 期待値: 245.3            │
│      [適用]              │  ← プレイモードのみ
├──────────────────────────┤
│ フルハウス(確定)         │
│ 期待値: 240.5            │
│      [確定]              │  ← プレイモードのみ
└──────────────────────────┘
```

### 6.3 評価結果の表示

**プレイモード**

- 全選択肢を期待値の降順で表示
- rollCount 1-2: 振り直し選択肢 + 役確定選択肢
- rollCount 3: 役確定選択肢のみ
- [適用]ボタン: ダイスをロック状態にしてパネルを閉じる
- [確定]ボタン: 役を確定して次のターンへ

**局面解析モード**

- 期待値を参照のみ
- [適用][確定]ボタンは表示しない

**期待値形式**: 小数第1位まで表示（例: 245.3）

---

## 7. 状態管理

### 7.1 RollCount型

```typescript
type RollCount = 0 | 1 | 2 | 3;
```

- **0**: まだ投げていない状態
- **1**: 1投目を終えた状態
- **2**: 2投目を終えた状態
- **3**: 3投目を終えた状態

**重要**: rollCountは「残りロール数」ではなく「投げ終わった回数」

### 7.2 rollsRemainingとの関係

```typescript
rollsRemaining = Math.max(0, 3 - rollCount);
```

- 初期状態: `rollCount: 0, rollsRemaining: 3`
- モード切り替え時にrollsRemainingを再計算
- 局面解析でrollCount変更時も再計算

### 7.3 モード間の同期

- プレイモード ⇄ 局面解析モード間でrollCountが自動同期
- ユーザーが両モードをシームレスに行き来可能

### 7.4 状態遷移（プレイモード）

```
初期状態 (rollCount: 0, rollsRemaining: 3)
  ↓ [サイコロを振る]
1投目 (rollCount: 1, rollsRemaining: 2)
  ↓ ダイスロック選択 → [サイコロを振る]
2投目 (rollCount: 2, rollsRemaining: 1)
  ↓ ダイスロック選択 → [サイコロを振る]
3投目 (rollCount: 3, rollsRemaining: 0)
  ↓ [確定]（1-2投目でも確定可能）
次のターン (rollCount: 0, rollsRemaining: 3)
  ↓
全13役確定でゲーム終了 → [リセット]
```

---

## 8. API連携

### 8.1 エンドポイント

```
POST /api/v1/evaluate
```

### 8.2 リクエスト

```json
{
  "scoreSheet": {
    "ace": null,
    "deuce": null,
    ...
  },
  "dice": [1, 2, 3, 4, 5],
  "rollCount": 2
}
```

- `rollCount`: 0/1/2/3（投げ終わった回数）
- rollCount === 0 のときはAPI呼び出し不可（評価ボタン非活性）

### 8.3 レスポンス

```json
{
  "data": [
    {
      "choiceType": "dice",
      "diceToHold": [3, 4],
      "expectedValue": 245.3
    },
    {
      "choiceType": "category",
      "category": "fullHouse",
      "expectedValue": 240.5
    }
  ]
}
```

### 8.4 呼び出しタイミング

- [評価を見る]ボタンクリック時
- 1回の呼び出しで全選択肢の評価を取得
- 期待値順にソート済み

---

## 9. レスポンシブ対応

### 9.1 ブレークポイント

- 〜768px: スマホ
- 768px〜1024px: タブレット
- 1024px〜: PC

### 9.2 配慮事項

- 基本レイアウトは全デバイス共通（縦積み）
- タッチ操作に適したボタンサイズ（最小44x44px）
- スコアシートのスクロール対応
- 入力欄のズーム防止（font-size: 16px以上）

---

## 10. 実装上の重要ポイント

### 10.1 型安全性

- rollCountを厳密に `0 | 1 | 2 | 3` で定義
- 不正な状態遷移を型レベルで防止

### 10.2 Fragmentの活用

- スコアシートで条件的に行を挿入
- `import { Fragment } from 'react'`
- シックスの直後に上段合計・ボーナス行を挿入

### 10.3 ボタン制御

- `rollCount === 0`: 評価ボタン非活性、確定ボタン非表示
- `rollsRemaining === 0`: サイコロを振るボタン無効化
- ゲーム終了時: リセットボタンに変更

### 10.4 プレビュー計算

- フロントエンドでスコア計算（`calculateScore`）
- APIに依存せず即座にプレビュー表示可能

---

## 11. エラーハンドリング・パフォーマンス

### 11.1 エラーハンドリング

- API呼び出し失敗時のエラー表示
- 不正な入力の検証
- ネットワークエラー時のリトライ機構

### 11.2 パフォーマンス

- 評価結果が多い場合の仮想スクロール検討
- API呼び出しのキャッシュ検討

### 11.3 アクセシビリティ

- キーボード操作対応
- ARIA属性によるスクリーンリーダー対応
- カラーコントラスト確保

---

## 12. 今後の検討事項

- [ ] 評価パネルでの詳細説明表示
- [ ] プレイモードでの「最善手を自動適用」機能
- [ ] ゲーム結果の保存・履歴・統計機能
- [ ] マルチプレイヤー対応
- [ ] ダークモード対応

---

## 変更履歴

**2024-12-25: 初版作成**

- 基本レイアウト、プレイモード、局面解析モード仕様確定

**2024-12-25: 実装完了版**

- rollCount型の拡張（0 | 1 | 2 | 3）と意味の明確化
- 役名をyacht-rules.mdに準拠
- UI配置変更（評価ボタン位置、ボーナス行位置）
- プレビュー表示 `(+XX)` の実装
- モード間rollCount同期の実装
- 評価ボタンの活性条件を両モード共通化
- rollsRemaining === 0でのボタン無効化
- 技術スタック確定（React 19 + TypeScript + Vite + Bun）
